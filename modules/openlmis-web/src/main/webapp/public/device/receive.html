<!--
  ~ This program is part of the OpenLMIS logistics management information system platform software.
  ~
  ~ This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.
  ~  
  ~ This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more details.
  ~ You should have received a copy of the GNU Affero General Public License along with this program.  If not, see http://www.gnu.org/licenses.  For additional information contact info@OpenLMIS.org. 
  -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
    <script src="js/jquery-1.11.3.min.js"></script>
    <!--<script src="js/queryScript.js"></script>-->
</head>
<body>
<h1 style="background-color:#E6E6FA;">Electronic Logistics Management Information System( ELMIS )</h1>
<div class="contents">
    <form id="shipmentform">
        <fieldset>
            <legend>Scan the ShipmentID</legend>
            <input type="text" name="shipment_id" id="shipment_id" /> &nbsp;&nbsp;&nbsp;
            <input type="button" value="Scan"  id="scan_sscc"/>
        </fieldset>
    </form>
    <div class="result"></div>
    <p id="message"><img src="../images/ajax-loader.gif" alt=""/></p>
</div>
<script>

    $(document).ready(function(){
        $("#message").hide();
        $("#shipment_id").focus();
        $( "#scan_sscc" ).click(function() {

            $("#message").show();
            $(".result").hide();
            if($("#shipment_id").val() != ""){
                var shipment_id = $("#shipment_id").val();
                $.ajax({
                    method: 'GET',
                    url: '/stock/manufacture/package?filter=shipment_id:eq:'+$("#shipment_id").val(),
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                }).success(function(data) {
                    if(!data.error){
                        if(data.manufacture_packages.length == 0){
                            $(".result").show().html('<h4>There is no package with this package number</h4>');
                        }else{
                            $(".result").html("");
                            var html = getShipmentinfo(data.manufacture_packages,shipment_id);
                            $(".result").show().html(html);
                            $("#shipmentform").hide('slow');

                            //processing package items
                            $("#lot_number").focus();
                            $("#scan_lot").click(function(){
                                if($("#lot_number").val() != "") {
                                    var lot_number = $("#lot_number").val();
                                    getSpecificLotNumber(lot_number);

                                }
                            });

                        }

                    }else{
                        $("#message").hide();
                    }
                    $("#message").hide();

                }).error(function(data){
                   alert('error');
                });
            }

        });


    });

function getShipmentinfo(shipment,shipment_id){
    var html = "<table><tr><td colspan='3'>shipment number: "+shipment_id+"</td> </tr>";
    html += '<tr><td>Scan the Lot Number</td>';
    html += '<td><input type="text" name="lot_number" id="lot_number" /> </td>';
    html += '<td><input type="button" value="Scan"  id="scan_lot"/></td></tr></table>';
    html += "<table border='1' cellpadding='0' cellspacing='0'>";
    html +="<tr>";
    html +="<th>GTIN</th>";
    html +="<th>Item</th>";
    html +="<th>Lot Number</th>";
    html +="<th>Expiry</th>";
    html +="<th>Boxes</th>";
    html +="</tr>";
    $.each(shipment, function(index, element) {
        html +="<tr>";
        html +="<td>"+element.vaccine_packaging.gtin+"</td>";
        html +="<td>"+element.vaccine_packaging.vaccine.name+"</td>";
        html +="<td>"+element.lot_number+"</td>";
        html +="<td>"+element.expire_date+"</td>";
        html +="<td>"+parseInt(element.number_of_doses/(element.vaccine_packaging.doses_per_vial*element.vaccine_packaging.vials_per_box))+"</td>";
        html +="</tr>";

    });
    html +="</table>";
    return html;
}

    function getSpecificLotNumber(LotNumber){
        $.ajax({
            method: 'GET',
            url: '/stock/manufacture/package?filter=lot_number:eq:'+LotNumber,
            headers: {'Content-Type': 'application/x-www-form-urlencoded'}
        }).success(function(data) {
            var html = '<table border="1" cellspacing="0" cellpadding="0">';
            html += ' <thead>';
            html += '     <tr><th>GTN</th><th>Item</th><th>Lot</th><th>Expiry</th><th>Vials</th><th>Boxes</th></tr>';
            html += ' </thead>';
            html += '<tr>';
            html += '<td>'+data.manufacture_packages[0].vaccine_packaging.gtin+'</td>';
            html += '<td>'+data.manufacture_packages[0].vaccine_packaging.vaccine.name+'</td>';
            html += '<td>'+data.manufacture_packages[0].lot_number+'</td>';
            html += '<td>'+data.manufacture_packages[0].expire_date+'</td>';
            html += '<td>'+parseInt(data.manufacture_packages[0].number_of_doses/data.manufacture_packages[0].vaccine_packaging.doses_per_vial)+'</td>';
            html += '<td>'+parseInt(data.manufacture_packages[0].number_of_doses/(data.manufacture_packages[0].vaccine_packaging.doses_per_vial*data.manufacture_packages[0].vaccine_packaging.vials_per_box))+'</td>';
            html += '</tr>';
            html += '</table>';

            html += '</br>';
            html += '<table>';
            html += '<tr><td>Quantity Okay</td><td><select><option>Yes</option><option>No</option></select></td></tr>';
            html += '<tr><td>Physical Damage</td><td><select><option>None</option><option>Damaged</option></select></td></tr>';
            html += '<tr><td>VVM Status</td><td><select><option>Good</option><option>Normal</option><option>Bad</option></select></td></tr>';
            html += '<tr><td>Temp monitors Status</td><td><select><option>Good</option><option>Normal</option><option>Bad</option></select></td></tr>';

            html += '</table>';

            html += '</br>';
            html += '<table>';
            html += '<tr>';
            html += '<td>Comments and Observations</td>';
            html += '</tr>';
            html += '<tr>';
            html += '<td><textarea></textarea></td>';
            html += '</tr>';
            html += '</table>';
            html += '</br>';
            html += '<table><tr><td><input type="submit"></td></tr></table>';

            $(".result").show().html(html);
        }).error(function(data){
            alert('error');
        });


    }
</script>

</body>
</html>
